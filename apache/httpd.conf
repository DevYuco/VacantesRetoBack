###############################################################################
#  httpd.conf – Reto Vacantes (frontend Angular + backend Java con Apache 2.4)
###############################################################################

# ---------------------------------------------------------------------------
# 1. Alias para los desafíos ACME (Certbot)
# ---------------------------------------------------------------------------
Alias /.well-known/acme-challenge/ "/var/www/certbot/.well-known/acme-challenge/"
<Directory "/var/www/certbot/.well-known/acme-challenge/">
    Require all granted
</Directory>

# ---------------------------------------------------------------------------
# 2. VirtualHost en HTTP → redirección a HTTPS
#    (dejamos pasar sólo la ruta del challenge)
# ---------------------------------------------------------------------------
<VirtualHost *:80>
    ServerName retovacantes.matabuena.com
    ServerAlias apireto.matabuena.com

    RewriteEngine On
    # Deja pasar las peticiones ACME
    RewriteRule ^/\.well-known/acme-challenge/ - [END]

    # Todo lo demás redirige a HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# ---------------------------------------------------------------------------
# 3. VirtualHost HTTPS – FRONTEND (Angular SPA)
# ---------------------------------------------------------------------------
<VirtualHost *:443>
    ServerName retovacantes.matabuena.com
    DocumentRoot /usr/local/apache2/htdocs          # <-- volumen montado

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/retovacantes.matabuena.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/retovacantes.matabuena.com/privkey.pem

    <Directory /usr/local/apache2/htdocs>
        Options FollowSymLinks Indexes
        AllowOverride All
        Require all granted
    </Directory>

    # Fallback para SPA: cualquier URL que no sea archivo real -> index.html
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ /index.html [L]

    # Logs al STDOUT/STDERR (se ven con 'docker logs apache')
    ErrorLog  /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

# ---------------------------------------------------------------------------
# 4. VirtualHost HTTPS – BACKEND (proxy al contenedor Java)
# ---------------------------------------------------------------------------
<VirtualHost *:443>
    ServerName apireto.matabuena.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/apireto.matabuena.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/apireto.matabuena.com/privkey.pem

    ProxyPreserveHost On
    ProxyPass        / http://backend:9005/
    ProxyPassReverse / http://backend:9005/

    ErrorLog  /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

###############################################################################
# 5. Notas
#    - Los módulos mod_ssl, mod_rewrite, mod_proxy y mod_proxy_http
#      vienen ya compilados en la imagen oficial httpd:2.4, no hay que cargarlos.
#    - Si cambias el nombre de la carpeta dist o los dominios,
#      ajusta DocumentRoot y ServerName/CertificateFile según corresponda.
###############################################################################
